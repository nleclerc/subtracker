<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

	<style>
		html,body {
			background-color: gray;
			padding: 0;
			margin: 0;
			height: 100%;
		}

		body {
			display: flex;
			flex-direction: column;
			font-family: sans-serif;
			overflow: hidden;
		}

		#header {
			flex: 0 0 auto;
			padding: .5rem 1rem;

			display: flex;

			background-color: black;
			color: white;

			box-shadow: 0 0 .5em rgba(0,0,0,.8);
			z-index: 1;

			font-size: 1.4em;
		}

		#header .title {
			flex: 0 0 auto;
			font-weight: bold;
		}

		#header .channelContainer {
			flex: 1 1 auto;
			font-weight: lighter;
		}

		#header .downloadLink {
			flex: 0 0 auto;
			width: 1.8em;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		#header .downloadLink img {
			height: 1em;
		}

		#sublist {
			flex: 1 1 auto;
			height: 10px;
			display: flex;
			flex-direction: column;
			overflow-y: auto;
		}

		.subitem {
			flex: 0 0 auto;
			padding: .5rem 1rem;
			background-color: white;
			display: flex;
			overflow: hidden;
			font-size: 1.3em;
			align-items: center;
		}

		.subitem .time {
			flex: 0 0 auto;
			margin-right: .5em;
			color: #888;
			font-weight: lighter;
		}

		.subitem .name {
			flex: 1 1 auto;
			margin-right: .5em;
			word-break: break-all;
		}

		.subitem .months {
			flex: 0 0 auto;
			display: flex;
			align-items: center;
			justify-content: center;
			background-color: gray;
			color: white;
			width: 2em;
			border-radius: 100%;
			font-weight: lighter;
		}

		.subitem+.subitem {
			border-top: 1px solid lightgray;
		}
	</style>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>

	<template id="subitem">
		<div class="subitem">
			<div class="time"></div>
			<div class="name"></div>
			<div class="months"></div>
		</div>
	</template>
</head>
<body>
	<div id="header">
		<div class="title">Subtracker</div>&nbsp;
		<div class="channelContainer"></div>
		<a class="downloadLink" href="downloadcsv" target="_blank"><img src="download-white.svg"></a>
	</div>

	<div id="sublist">
	</div>

	<script type="text/javascript">
		const channelContainer = document.querySelector('#header .channelContainer')
		const sublist = document.querySelector('#sublist');
		const subitemTemplate = document.querySelector('template#subitem');

		const socket = io();
		async function emit(message,...args) {
			return await new Promise((resolve,reject)=>
				socket.emit(message,...args,(err,result)=> {
					if (err)
						reject(err);
					else
						resolve(result);
				})
			);
		};

		function getTime(date) {
			return moment(date).format('HH:mm');
		}

		function last(array) {
			if (Array.isArray(array) && array.length > 0)
				return array[array.length-1];
			return null;
		}

		function addEntry(subEntry){
			console.log('Adding sub:',subEntry);
			let fragment = subitemTemplate.content.cloneNode(true);
			fragment.querySelector('.time').textContent = getTime(subEntry.creation_date);
			fragment.querySelector('.name').textContent = subEntry.user;
			fragment.querySelector('.months').textContent = subEntry.months;
			sublist.appendChild(fragment);
		}

		let lastUpdateTime = null;
		async function refresh() {
			console.log('Refreshing data.',lastUpdateTime);
			let result = await emit('refresh',lastUpdateTime);
			let lastItem = last(result);
			if (lastItem)
				lastUpdateTime = lastItem.creation_date;
			result.forEach(addEntry);
		}

		socket.on('connect',()=> {
			console.log('Connected.');
			refresh();
		});

		socket.on('channel',(chan)=> {
			console.log('Tracking channel:',chan);
			channelContainer.textContent = '#'+chan;
		});

		socket.on('newsub',(subdata)=> {
			console.log('newsub:',subdata);
			lastUpdateTime = subdata.creation_date;
			addEntry(subdata);
		});
	</script>
</body>
</html>
